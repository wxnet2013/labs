<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" href="http://a.tbcdn.cn/p/global/1.0/global-min.css" />
<style>
#demo1{
  width:380px;
  height:300px;
  margin:0px auto;
}
</style>
<script charset="utf-8" src="http://g.tbcdn.cn/kissy/k/1.4.0/seed-min.js"></script>
</head>
<body>
<div id="demo1">
</div>
<script>
var getMillisecond = function(data) {
	        var strs = data.split('-');
            return new Date(
                    parseInt(strs[0], 10),
                    parseInt(strs[1], 10) - 1,
                    parseInt(strs[2], 10)
                ).getTime();
};
		
var formatDate = function(time) {
			        var date, year, month, day;

			        date = new Date(time);
			        year = date.getFullYear();
			        month = date.getMonth() + 1;
			        day = date.getDate();

			        return year + '-' +
			            (month > 9 ? '' : '0') + month + '-' +
			            (day > 9 ? '' : '0') + day;
};

var data_pricetrend = {
	rp : 3699.00,
	points : [
	['2013-09-22',5288],
	['2014-01-09',1688],
	['2014-01-10',2687.89],
	['2014-01-16',5288],
	['2014-01-17',2687.89],
	['2014-01-20',5288],
	['2014-01-21',2687.89],
	['2014-02-25',2688]
]};

var data_pricetrend = {rp : 3300.360000,points : [['2013-09-17',5488],['2013-09-18',5288],['2013-09-19',5666],['2013-09-26',5399],['2013-09-27',5479],['2013-09-28',5499],['2013-09-29',5688],['2013-09-30',5720.2],['2013-10-01',5788.47],['2013-10-07',5450.42],['2013-10-09',5550.48],['2013-10-11',5699.05],['2013-10-12',5600.28],['2013-10-13',5650.12],['2013-10-14',5550.48],['2013-10-15',5700],['2013-10-16',5595.53],['2013-10-17',5590.2],['2013-10-18',5550.48],['2013-10-21',5480.02],['2013-10-25',5100.3],['2013-10-26',5200.25],['2013-10-27',5130.26],['2013-10-30',5430],['2013-11-05',5399],['2013-11-06',5359],['2013-11-07',5888],['2013-11-08',5510],['2013-11-11',5399],['2013-11-14',5450],['2013-11-16',5490],['2013-11-17',5540],['2013-11-18',5240],['2013-11-19',5199],['2013-11-24',5100],['2013-11-26',5099.76],['2013-11-29',4998.55],['2013-12-02',5049.86],['2013-12-03',5019.95],['2013-12-04',5020],['2013-12-05',5049.86],['2013-12-07',5019.95],['2013-12-12',4998.55],['2013-12-21',4977.68],['2013-12-22',4977.68],['2013-12-24',4967.72],['2013-12-29',4998.55],['2013-12-31',4999.08],['2014-01-11',5050.4],['2014-01-14',4999.08],['2014-01-15',4799.18],['2014-01-16',4788.32],['2014-01-19',4850.27],['2014-01-21',4788.32],['2014-01-23',4790.2],['2014-01-24',4840.34],['2014-01-25',4850.27],['2014-02-04',4820.48],['2014-02-07',4799.18],['2014-02-08',4829.47],['2014-02-09',4850.27],['2014-02-15',4799.18],['2014-02-16',4829.47],['2014-02-23',5000.02],['2014-02-24',5030.45],['2014-02-25',5030]]};

var data_pricetrend = {rp : 2436.570000,points : [['2013-10-23',3588],['2013-10-30',3499.02],['2013-11-01',3488.29],['2013-11-05',3468.26],['2013-11-06',3498.31],['2013-11-11',3509.06],['2013-11-12',3498.31],['2013-11-13',3598.31],['2013-11-16',3648.32],['2013-11-20',3659.23],['2013-11-21',3588.06],['2013-11-22',3538.15],['2013-11-23',3499.09],['2013-11-26',3399.18],['2013-11-29',3388.28],['2013-12-01',3377.02],['2013-12-02',3358.3],['2013-12-04',3368.23],['2013-12-05',3299.3],['2013-12-06',3368.33],['2013-12-09',3358.22],['2013-12-12',3298.14],['2013-12-14',3205.23],['2013-12-16',3199.06],['2013-12-19',3198.01],['2013-12-26',3248.3],['2013-12-27',3198.01],['2014-01-03',3298.24],['2014-01-17',3448.08],['2014-01-19',3398.17],['2014-01-20',3488.29],['2014-01-21',3448.09],['2014-01-28',3428.19],['2014-02-08',3398.17],['2014-02-09',3348.26],['2014-02-11',3398.17],['2014-02-12',3388.04],['2014-02-15',3358.02],['2014-02-18',3348.26],['2014-02-19',3368.15],['2014-02-20',3358.12],['2014-02-21',3288.16],['2014-02-22',3288.16],['2014-02-25',3288]]};





//补全数据
function data(points){
	var pTime = getMillisecond(points[0][0]),pTime,_data,rtn = [points[0]];
	for(var i=1;i<= points.length - 1;i++){
		pTime += 24 * 3600 * 1000;
	    if (getMillisecond(points[i][0]) !== pTime) {
	   	    _data = [formatDate(pTime),points[--i][1]];
	   	} else {
	   		_data = points[i];
	   	}
		rtn.push(_data);
	}
	return rtn;
}

data_pricetrend.points = data(data_pricetrend.points);
//console.log(data_pricetrend.points);

KISSY.Config.combine = true;

KISSY.use("gallery/kcharts/1.3/linechart/index",function(S,LineChart){
 
  var xAxisText = [],
  seriesData = [],
  lowestPrice=0,maximumPrice=0,
  lowestPriceIndex=0,pointsLenth = data_pricetrend.points.length;
	
  S.each(data_pricetrend.points,function(v){
  	xAxisText.push(v[0]);
	seriesData.push(v[1]);
  });
  
  
  maximumPrice = Math.max.apply(null,seriesData);
  
  //历史最低
  lowestPrice = Math.min.apply(null,seriesData);
  //标记最低价格
  for(;lowestPriceIndex<pointsLenth;lowestPriceIndex++){
  	if(seriesData[lowestPriceIndex] == lowestPrice) break;
  }

  //今天价格
  
  //标记最低价格
  var markLowestPrice = function(lineChart, lowestPrice){
  			if( !lineChart || !lowestPrice ) return;

  			var pointMap = lineChart._points[0];
  			var index = lowestPrice.index;

  			var point = pointMap[index];

  			var raphaelPaper = lineChart.getRaphaelPaper();

  			if(raphaelPaper)
  				raphaelPaper.circle(point.x, point.y, 3).attr({
  					"stroke" : "#F60",
  					"fill" : "#FFF"
  				});

 };
 
 /*
 var drawRPLine = function(lineChart, rp){

 			if(!lineChart || !rp) return;

 			//获取主绘图区域
 			var container = lineChart.getInnerContainer();

 			//获取html画布
 			var htmlPager = lineChart.getHtmlPaper();

 			if(!htmlPager) return;

 			//取得点的y坐标
 			var pointsY = lineChart.data2GrapicData(rp, false, true);

 			//画横线
 			htmlPager.lineX(container.tl.x, pointsY, container.width).css({"border-top" : "2px dashed #377BEE"});

 			//写入平均值文本
 			htmlPager.text(container.tl.x + container.width, pointsY, '&yen;' + rp, "right", "bottom").css({"color":"#377BEE"});

 };
 */
  var linechart = new LineChart({
      renderTo:"#demo1",
	  "colors" : ["#F60"],
      points:{
		  "attr" : {
		  						"r" : 0
		  					},
		  		"hoverAttr" : {
		  						"stroke" : "#F60",
		  						"fill" : "#F60",
		  						"r" : 3
				}
      },
	  //坐标样式
      yLabels:{
        css:{
          "marginLeft":"-4px",
          "font-family":"Microsoft Yahei",
          "font-size":"10px"
        }
      },
      xLabels:{
        css:{
          "font-family":"Microsoft Yahei",
           "font-size":"10px"
        },
		template:function(index,text){
			//console.log([index,text]);
			var len = seriesData.length;
			if(index!=0 && index!=len-1 
				&& index % parseInt(len/6) != 0 || index!=0 && 
				index!=len && index >= ( len - parseInt(parseInt(len/6)/2))){
				return '';
			} else {
				return text.substr(5);
			}
		}
      },
	  xGrids:{
	  		isShow : false
	  },
	  //设置标题
      title:{
              content:"价格趋势"
      },
      xAxis: {
		  text: xAxisText
      },
      yAxis:{
		  max:maximumPrice*1.1,
		  min:lowestPrice*.9
      },
      comparable:true,
      series:[
	  		{
                data: seriesData
            }
      ],
      tip:{
        offset:{
			x:10,
            y:10
        },
        template:function(e){
          var html = "";
          for(var i in e.datas){
			  html+="日期:" + e.datas[i]['x'] + "<br/>";
			  html+="价格:&yen;" + e.datas[i]['y'];
          }
          return html;
        }
      }
  });
  
  markLowestPrice(linechart,{index:lowestPriceIndex});
  
  //drawRPLine(linechart,3699.00)

});



</script>
</body>
</html>